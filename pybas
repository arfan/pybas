#!/usr/bin/env python3

# basic_interpreter.py
import sys

class BasicInterpreter:
    def __init__(self, program_lines):
        self.program = {}
        self.vars = {}
        self.pc = None
        self.stack = []

        # Load program into a dict {line_number: statement}
        for line in program_lines:
            line = line.strip()
            if not line or line.startswith("'"):  # allow comments
                continue
            num, stmt = line.split(" ", 1)
            self.program[int(num)] = stmt.strip()

        self.pc = min(self.program.keys())

    def run(self):
        while self.pc in self.program:
            stmt = self.program[self.pc]
            self.execute(stmt)
            if stmt.startswith("END"):
                break

            # Move to next line if not changed by GOTO/GOSUB
            if self.pc in self.program:
                next_lines = sorted([n for n in self.program if n > self.pc])
                self.pc = next_lines[0] if next_lines else None

    def execute(self, stmt):
        if stmt.startswith("LET"):
            # Example: LET A = 5
            _, expr = stmt.split(" ", 1)
            var, val = expr.split("=")
            self.vars[var.strip()] = eval(val.strip(), {}, self.vars)

        elif stmt.startswith("PRINT"):
            _, expr = stmt.split(" ", 1)
            print(eval(expr.strip(), {}, self.vars))

        elif stmt.startswith("INPUT"):
            # Example: INPUT "Enter your name: ", NAME
            _, expr = stmt.split(" ", 1)
            if "," in expr:
                prompt, var = expr.split(",", 1)
                prompt = prompt.strip().strip('"')
                var = var.strip()
                user_input = input(prompt)
                # Try to convert to number if possible, otherwise keep as string
                try:
                    self.vars[var] = float(user_input) if '.' in user_input else int(user_input)
                except ValueError:
                    self.vars[var] = user_input
            else:
                # Simple INPUT without prompt
                var = expr.strip()
                user_input = input()
                try:
                    self.vars[var] = float(user_input) if '.' in user_input else int(user_input)
                except ValueError:
                    self.vars[var] = user_input

        elif stmt.startswith("END"):
            print("Program finished.")

        else:
            print(f"Unknown statement: {stmt}")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: pybas program.pybas")
        sys.exit(1)

    filename = sys.argv[1]
    with open(filename) as f:
        lines = f.readlines()

    interpreter = BasicInterpreter(lines)
    interpreter.run()
